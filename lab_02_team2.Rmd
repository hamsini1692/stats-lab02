---
title: "W203 Lab 02 Report - Team 02"
author: 'Ayoade Israel, Divya Menghani, Hamsini Sankaran, Sivakumar Thiyagarajan'
output:
  pdf_document:
    toc: no
    number_sections: yes
    extra_dependencies: ["float"]
include-before:
  - \vspace{-0.6in}
header-includes:
  - \usepackage{titling}
  - \setlength{\droptitle}{-1.1in}

urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load packages and set options, include=FALSE}
library(tidyverse)
library(magrittr)
library(stargazer)
library(sandwich)
library(lmtest)
library(knitr)
library(patchwork)
library(moments)
library(scales)
library(ggplot2)
library(dplyr)
library(tidyr)
library(gridExtra)
library(kableExtra)
library(readr)
library(car)
source("data_cleaning.R")
library(corrplot)
library(Hmisc)
library(cowplot)
theme_set(theme_bw())
options(tinytex.verbose = TRUE)
knitr::opts_chunk$set(echo=FALSE, message=FALSE)
library(caret)
library(stringr)
```


```{r load data, warning=FALSE, echo=FALSE, results='hide', message=FALSE}
movie_data <- read_csv("./datasets/movies_data.csv")
nrow_original <- nrow(movie_data)
```

```{r call the dataframe, echo=FALSE, results='hide', message=FALSE, warning=FALSE}

# Call the function to preprocess the data
movie_filtered_df <- data_cleaning()

nrow_cleaned <- nrow(movie_filtered_df)
nrow_cleaned

filtered_rows <- nrow(movie_filtered_df)
difference <- nrow_original - filtered_rows
difference

```

```{r data exploration, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# randomly sample 30% of rows from movie_filtered_df
set.seed(123) # set seed for reproducibility

#Split data into 30% and 70% using caret's createDataPartition function
index <- createDataPartition(movie_filtered_df$revenue, p = 0.3, list = FALSE)

# Create the 30% sample for data exploration
movie_sample_exploration <- movie_filtered_df[index,]

# Create the 70% sample for statistical test
movie_sample_statistical <- movie_filtered_df[-index,]

movie_sample_exploration <- movie_filtered_df %>% 
  sample_frac(0.3, replace = FALSE)
rows_exploratrion <- nrow(movie_sample_exploration)

# Create the 70% sample for statistical test
movie_sample_statistical <- movie_filtered_df[-index,]
movie_sample_exploration <- movie_filtered_df %>% 
  sample_frac(0.3, replace = FALSE)
rows_statistical <- nrow(movie_sample_exploration)
rows_exploratrion
```

## Introduction 
As today's housing stock ages, the choice to remodel a property is driven by many factors, some personal and some market-wide. For many owners, a major concern is the effect a remodel will have on future revenues, including those from renting and from selling the property. Some may turn to real estate professionals for guidance. In a 2019 survey performed by the National Association of Realtors, members estimated the financial benefit of different type of remodels, ranging from \$2,500 for a closet renovation up to \$20,000 for a full kitchen remodel. 

While experts may provide broad guidelines, data-based approaches are needed to reduce uncertainty in the value of remodels. In the aggregate, remodeling accounts for $400 billion spent each year in the US.^[La Jeunesse, Elizabeth. “Healthy Home Remodeling: Consumer Trends and Contractor Preparedness.” Harvard’s Joint Center for Housing Studies (2019).] Uncertainty in how much of this money can be recouped may contribute to the misallocation or underprovision of resources in this sector of the economy.

This study estimates the economic value for remodeling a home empirically, utilizing observations of house sales in Ames, Iowa. The data shows the timing of the last remodel before a house is sold, but does not distinguish between different types of remodels. Applying a set of regression models, I estimate the value that results immediately when a house is remodeled, and also the rate at which it decays over time.

The movie industry is a multi-billion dollar business, and the budget of a film has become a crucial factor in determining its success, particularly in terms of revenue. Movie production firms, who have control over the budget, are highly motivated to enhance their movie revenue. This study aims to explore the relationship between movie budget (X concept) and revenue (Y concept) using a comprehensive dataset containing metadata for over 700,000 movies listed in the TMDB Dataset. The dataset provides a unique opportunity to analyze the impact of budget on movie revenue, with both the X and Y concepts operationalized in terms of dollar amounts. However, there may be other omitted variables, such as the movie's storyline and competition from other movies, that could also impact revenue. The results of this study will have important implications for movie production firms, who can use the findings to make informed decisions about their investments in movie budgets. Future research could focus on generating new datasets to estimate the value of specific types of movies, such as different genres or production companies. Overall, the goal of this line of research is to provide accurate tools for movie production firms to make informed decisions about their investments and reduce uncertainty in the movie industry.

## Data and Methodology

We gathered the dataset from Kaggle. The dataset comprises metadata for more than 700,000 movies listed in the TMDB Dataset. It has 722986 rows and 20 columns. It is relevant and provides an opportunity to analyze the relationship between the budget and the revenue of the movies. The dataset contains unique information on films, with each movie being distinct from the others and identified by an id column in the dataset. Additionally, the distribution of the X and Y concept is identical, satisfying the assumptions of IID. Because each movie is not subject to multiple samplings, the dataset is regarded as cross-sectional.Each row in the data represents a movie. I performed all exploration and model building on a 30\% subsample of the data. The remaining 70\%, totaling `r nrow_cleaned` rows, was used to generate the statistics in this report.

To determine the factors that affect movie revenue, we need to extensively analyze data and conduct research .To analyze the factors that affect movie revenue, we have defined inclusion criteria that could potentially impact the dependent variable "revenue" (Y), and selected "budget" as the independent variable. We are focusing on movies that have been officially released to the public, and to refine our analysis, we are excluding movies with budgets or revenues exceeding $999 and budget values of $5 billion and $800 million. After filtering the data, we are left with a sample size of r filtered_rows observations.

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.height = 3, fig.width = 3}
selected_columns <- movie_sample_exploration %>%
  dplyr::select(budget, revenue, runtime, vote_count, title_length, popularity)
cor_matrix <- rcorr(as.matrix(selected_columns), type = "pearson")$r
result_corr <- corrplot(cor_matrix, method = "color",  order = "hclust", 
         tl.col = "black", tl.srt = 45, type = "upper", tl.cex = 0.6, cl.cex=0.6, title = "Correlation Plot", title.cex=0.8,mar = c(1, 1, 3, 1))

main_plot <- ggplot(movie_sample_exploration, 
       aes(x=budget/1000000, y=revenue/1000000)) +
  geom_point(color='darkblue') +
  geom_smooth(se=FALSE) +
  xlab("Budget") +
  ylab("Revenue") +
  ggtitle("Budget vs Revenue") +
  scale_x_continuous(labels = scales::comma) +
  scale_y_continuous(labels = scales::comma)

ggdraw() +
  draw_plot(result_corr, x = 0.6, y = 0.5, width = 0.4, height = 0.4) + 
  draw_plot(main_plot)

```


I am interested in analyzing the relationship between movie revenue and budget, and identifying the factors that impact this relationship. To determine the covariates that impact the dependent variable, we have chosen the following variables:

- Runtime: An important aspect of the movie-watching experience that has a correlation with revenue.
- Vote_count: A proxy for popularity and an indicator of the level of engagement a movie has received from the public.
- Popularity: A comprehensive metric that takes into account various factors such as user ratings, page views, and social media mentions.
- Title_length: A factor that can impact audience interest and expectations, with shorter titles being easier to remember and share.

We choose these covariates  based on their potential impact on the dependent variable, and have been widely studied and recognized in the industry. By including these covariates in our analysis, we aim to gain insights into the factors that affect movie revenue and provide recommendations for filmmakers to optimize their marketing and production strategies. We operationalize the variables Budget(X) and Revenue(Y) in terms of amount. This form was chosen to best fit the relationship seen in exploratory plots. Figure 1 plots revenue as a function of budget. There is a general positive relationship between budget and revenue

- The age of the house when remodeled. It is possible that remodeling an older home results in a larger value increase than remodeling a newer home.
- The time between the remodel and the sale. It is possible that remodels become more or less valuable over time, and the rate of change may be different than that of houses in general.

Exploratory plots suggest that both effects exist and that both are roughly linear. I therefore create regression models in which the "boost" from remodeling increases by a fixed amount with the age of the house when remodeled, and also changes by another fixed amount with each year that passes after the remodel. In other words, I fit regressions of the form,

$$
  \widehat{revenue}=\beta_0 + \beta_1\cdot Budget + \beta_2 \cdot votecount + \beta_3 \cdot title length + \beta_4 \cdot run time +  \mathbf{Z\gamma}
$$

where $R$ is an indicator for remodeling, $\beta_1$ represents the immediate increase in value per year the house existed before remodeling, $\beta_2$ represents the change in the value increase for each year that passes after the remodel, $\mathbf{Z}$ is a row vector of additional covariates, and $\mathbf{\gamma}$ is a column vector of coefficients.

I considered specifications that also include the modeling indicator $R$ by itself (i.e. uninteracted). This type of model allows for the possibility that even a brand new house that is remodeled immediately increases in value. However, when fitting such models in the exploration set, the resulting coefficient was practically small (equivalent to reducing the age of a home by 1 to 2 years) and non-significant. To improve the precision of my estimates and the simplicity of the model, I removed this term.

## Results

```{r fit models, echo=FALSE, message=FALSE, warning=FALSE}
# removed production_companies, total_cast
movie_sample_statistical$log_budget <-log(movie_sample_statistical$budget/1000000)
movie_sample_statistical$log_vote_count <-log(movie_sample_statistical$vote_count)
movie_sample_statistical$log_title_length <- log(movie_sample_statistical$title_length)
movie_sample_statistical$log_revenue <-log(movie_sample_statistical$revenue/1000000)

```

```{r, include=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
library(lubridate)

#movie_sample_statistical_test <- movie_sample_statistical

#movie_sample_statistical$release_date_cat <- ifelse(wday(movie_sample_statistical$release_date) %in% c(1, 6, 7), "1", "0")

movie_sample_statistical$lang_cat <- ifelse(movie_sample_statistical$original_language %in% c("en"), "1", "0")

movie_sample_statistical$release_date_cat <- ifelse(month(movie_sample_statistical$release_date) %in% c(1,12), "1", "0")

#movie_sample_statistical$release_date_cat <- ifelse(wday(movie_sample_statistical$release_date) %in% c(1, 6, 7), "1", "0")
#ifelse(yday(movie_sample_statistical$release_date) %in% c(1, 327, 365), "1", "0")

# weekend - 1
# weekday - 0

#View(movie_sample_statistical)

```

```{r, message=FALSE, warning=FALSE, fig.width=10, fig.height=3}
#table(movie_sample_statistical$release_date_cat)

#library("writexl")
#write_xlsx(movie_sample_statistical,"C:\\Users\\sivak\\Downloads\\movies\\movies_release_cat.xlsx")

plot_release_cat <- ggplot(movie_sample_statistical, 
       aes(x=budget/1000000, y=revenue/1000000, color=release_date_cat)) +
  geom_point() +
  geom_smooth(se=FALSE) +
  xlab("Budget") +
  ylab("Revenue") +
  ggtitle("Budget vs Revenue") +
  scale_x_continuous(labels = scales::comma) +
  scale_y_continuous(labels = scales::comma)

plot_lang_cat <- ggplot(movie_sample_statistical, 
       aes(x=budget/1000000, y=revenue/1000000, color=lang_cat)) +
  geom_point() +
  geom_smooth(se=FALSE) +
  xlab("Budget") +
  ylab("Revenue") +
  ggtitle("Budget vs Revenue") +
  scale_x_continuous(labels = scales::comma) +
  scale_y_continuous(labels = scales::comma)

(plot_release_cat | plot_lang_cat)

```

```{r heat map, fig.align='center', fig.height=3, fig.width=5}

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}


model <- lm(log_revenue ~ log_budget, data = movie_sample_statistical)
#summary(model)

#model_11 <- lm(log_revenue ~ log_budget + lang_cat, data = movie_sample_statistical)
#summary(model_11)

#model_12 <- lm(log_revenue ~ log_budget + lang_cat + runtime + vote_count, data = movie_sample_statistical)
#summary(model_12)
                                                     
#model_1 <- lm(log_revenue ~ log_budget + vote_count, data = movie_sample_statistical)
#summary(model_1)

model_2 <- lm(log_revenue ~ log_budget + vote_count + runtime , data = movie_sample_statistical)
#summary(model_2)

#model_3 <- lm(log_revenue ~ log_budget + vote_count+  runtime + popularity, data = movie_sample_statistical)
#summary(model_3)

#model_4 <- lm(log_revenue ~ log_budget + vote_count + runtime + popularity + log_title_length, data = movie_sample_statistical)

model_5 <- lm(log_revenue ~ log_budget + vote_count + runtime + popularity + log_title_length + release_date_cat + lang_cat, data = movie_sample_statistical)
#summary(model_5)

#model_tst <- lm(log_revenue ~ log_budget + vote_count + release_date_cat, data = movie_sample_statistical)


#summary(model_5)
```
Table 1 shows the results of three regression models. The co-efficient of the X-concept variable "Budget" is having high statistical significane in all the three models studied. Its point estimates ranges from 0.78 to 0.91. 

```{r display regression table, message=FALSE, echo=FALSE, results='asis', warning=FALSE}
get_robust_se <- function(model) {
  se <- sqrt(diag(vcovHC(model, type = "HC1")))
  return(se)
}
rse_model <- get_robust_se(model)
#rse_model_1 <- get_robust_se(model_1)
rse_model_2 <- get_robust_se(model_2)
#rse_model_3 <- get_robust_se(model_3)
#rse_model_4 <- get_robust_se(model_4)
rse_model_5 <- get_robust_se(model_5)

#Stargazer table along with robust standard error
#Stargazer table along with robust standard error
stargazer(model, model_2, model_5,
          type = "latex",
          omit.stat = "f",
          se=list(rse_model, rse_model_2, rse_model_5),
          title = "Estimated Regressions",
          header=FALSE,
          dep.var.caption  = "Output Variable: Revenue of the movie",
          covariate.labels = c("Budget", "Vote Count", "Run time", "Popularity", "Movie Title Length", "Release season", "Release Language"),
          dep.var.labels   = "",
          digits=3,
          star.cutoffs = c(0.05, 0.01, 0.001),
          notes.append = FALSE,
          notes = "\\parbox[t]{7cm}{$HC_1$ robust standard errors specified in parentheses. Holiday season is Dec/Jan and rest of the months are considered as non-holiday season. Language Category is either English or Non-English movies.}"
          )
```
