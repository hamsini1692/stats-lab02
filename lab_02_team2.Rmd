---
title: "W203 Lab 02 Report - Team 02"
author: 'Ayoade Israel, Divya Menghani, Hamsini Sankaran, Sivakumar Thiyagarajan'
output:
  pdf_document:
    toc: no
    number_sections: yes
    extra_dependencies: ["float"]
include-before:
  - \vspace{-0.6in}
header-includes:
  - \usepackage{titling}
  - \setlength{\droptitle}{-1.1in}
  - \usepackage{float}
  - \usepackage{titlesec}
  - \titlespacing{\title}{-1pt}{\parskip}{-\parskip}

urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load packages and set options, include=FALSE}
library(tidyverse)
library(magrittr)
library(stargazer)
library(sandwich)
library(lmtest)
library(knitr)
library(patchwork)
library(moments)
library(scales)
library(ggplot2)
library(dplyr)
library(tidyr)
library(gridExtra)
library(kableExtra)
library(readr)
library(car)
source("data_cleaning.R")
library(corrplot)
library(Hmisc)
library(cowplot)
theme_set(theme_bw())
options(tinytex.verbose = TRUE)
knitr::opts_chunk$set(echo=FALSE, message=FALSE)
library(caret)
library(stringr)
library(ggcorrplot)
```


```{r load data, warning=FALSE, echo=FALSE, results='hide', message=FALSE}
movie_data <- read_csv("./datasets/movies_data.csv")
nrow_original <- nrow(movie_data)
```

```{r call the dataframe, echo=FALSE, results='hide', message=FALSE, warning=FALSE}

# Call the function to preprocess the data
movie_filtered_df <- data_cleaning()

nrow_cleaned <- nrow(movie_filtered_df)
nrow_cleaned

filtered_rows <- nrow(movie_filtered_df)
difference <- nrow_original - filtered_rows
difference

```

```{r data exploration, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# randomly sample 30% of rows from movie_filtered_df
set.seed(123) # set seed for reproducibility

#Split data into 30% and 70% using caret's createDataPartition function
index <- createDataPartition(movie_filtered_df$revenue, p = 0.3, list = FALSE)

# Create the 30% sample for data exploration
movie_sample_exploration <- movie_filtered_df[index,]

# Create the 70% sample for statistical test
movie_sample_statistical <- movie_filtered_df[-index,]

movie_sample_exploration <- movie_filtered_df %>% 
  sample_frac(0.3, replace = FALSE)
rows_exploratrion <- nrow(movie_sample_exploration)

# Create the 70% sample for statistical test
movie_sample_statistical <- movie_filtered_df[-index,]
movie_sample_exploration <- movie_filtered_df %>% 
  sample_frac(0.3, replace = FALSE)
rows_statistical <- nrow(movie_sample_exploration)
rows_exploratrion
rows_statistical
```

# Introduction 
The movie industry is a multi-billion dollar business, and the budget of a film has become a crucial factor in determining its success, particularly in Revenue. Movie production firms have control over the budget and are highly motivated to enhance their movie revenue. The global movies and entertainment market generated an estimated revenue of USD 90.92 billion in 2021. According to projections, the market is expected to grow at a compound annual growth rate (CAGR) of 7.2% between 2022 and 2030. By 2030, the market is anticipated to reach a total revenue of USD 169.68 billion^[Grand View Research, "Movies And Entertainment Market Size, Share & Trends Analysis Report, By Region, And Segment Forecasts, 2022 - 2030".].

 Although numerous studies have been conducted on predicting movie revenue, there have been instances in which movies with large budgets and compelling plotlines failed to perform at the box office, such as Mulan (Budget: \$200 million, Revenue: \$69 million). In contrast, movies with relatively lower budgets succeeded, such as Super Size Me (Budget: $65K, $22 million)^[BuzzFeed, "10 Films That Flopped At The Box Office Despite Mammoth Budgets, And 9 Low-Budget Movies That Made Hefty Profits", 2023.]. It raises questions about what factors influence a movie's success.
 
Our research aims to gain insights into the factors that affect movie revenue and provide recommendations for filmmakers to optimize their marketing and production strategies, using a comprehensive dataset. One of the drawbacks of existing research in predicting movie revenue is the difficulty in accurately capturing the impact of other complex factors that influence a movie's success apart from budget. In this study, by applying a set of regression models, we estimate a movie's revenue based on budget along with several other factors.


# Data and Methodology

We gathered the dataset from Kaggle. The dataset comprises metadata of more than 700,000 movies listed in the TMDB Dataset. It has 722986 rows and 20 columns representing various factors influencing the movie's success. It is relevant and provides an opportunity to analyze the relationship between the budget and the Revenue of the movies. The dataset contains unique information on movies, with each movie being distinct from the others and identified by an id column in the dataset.  

We performed exploratory studies and model building on a 30\% subsample of the data. The remaining 70\%, totaling `r nrow_cleaned` rows, is used for testing the model and evaluating the results in this report. To meet the large sample assumptions, we are evaluating the assumptions of I.I.D and Unique BLP. From the exploratory data analysis, although the budget and revenue distribution was roughly identical, we observed that our dataset is not strictly I.I.D (further discussed in the Limitations section), and it does not have finite variance from the histogram plots, eventually violating the unique BLP assumption. We performed a log transformation of the predictor variables (budget and title length) to overcome this. Because each movie is not subjected to multiple samplings, the dataset is regarded as cross-sectional.  

We cleaned data by ignoring the rows with missing values in all dependent and independent variables. From the exploratory plots, we observed few outliers for budget, and we are considering the movies with a budget greater than \$999 and excluding movies with a budget greater than \$799 million. After filtering the data, we are left with a sample size of `r filtered_rows` observations.  

To best fit the relationship observed in exploratory plots, we operationalize the variables Budget(X) and Revenue(Y) in terms of amount (in dollars, $). Figure 2 shows a plot of Revenue as a function of budget, depicting a linear relationship between the two variables. Figure 1 shows the "pearson" correlation between the dependent and all independent variables. Based on the correlation score, we chose the following covariates that affect the dependent variable (Revenue). By including them in our analysis, we will better understand the fundamental factors that influence the movie revenue.

- vote_count (count): An indicator of the level of public engagement a movie has received.
- runtime (minutes): An essential aspect of the movie-watching experience that has a correlation with Revenue.

```{r fit models, echo=FALSE, message=FALSE, warning=FALSE}
# removed production_companies, total_cast
movie_sample_exploration$log_budget <-log(movie_sample_exploration$budget/1000000)
movie_sample_exploration$log_title_length <- log(movie_sample_exploration$title_length)
movie_sample_exploration$log_revenue <-log(movie_sample_exploration$revenue/1000000)
```



```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.height = 3, fig.width = 3}
selected_columns <- movie_sample_exploration %>%
  dplyr::select(budget, revenue, runtime, vote_count, title_length, popularity)

cor_matrix <- cor(selected_columns, method = "pearson")

ggcorrplot(cor_matrix, type = "upper", colors = c("#6D9EC1", "white", "#E46726"), lab_size = 1, hc.order = TRUE) +
  ggtitle("Figure 1. Correlation Plot") +
  theme(plot.title = element_text(hjust = 0.5, size = 10), axis.title = element_text(size=18), legend.title = element_text(size=10))

main_plot <- ggplot(movie_sample_exploration, 
       aes(x=log_budget, y=log_revenue)) +
  geom_point(color='darkblue') +
  geom_smooth(se=FALSE) +
  xlab("Budget") +
  ylab("Revenue") +
  ggtitle("Figure 2. Budget vs Revenue") +
  scale_x_continuous(labels = scales::comma) +
  scale_y_continuous(labels = scales::comma) + 
  theme(plot.title = element_text(hjust = 0.5,size=10), axis.title = element_text(size=10), legend.title = element_text(size=10))

ggdraw() +
  draw_plot(main_plot)

```



```{r, include=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
library(lubridate)
movie_sample_exploration$lang_cat <- ifelse(movie_sample_exploration$original_language %in% c("en"), "1", "0")
movie_sample_exploration$release_date_cat <- ifelse(month(movie_sample_exploration$release_date) %in% c(1,12), "1", "0")
```


- popularity (score): A comprehensive metric that considers various factors such as promotions and social media mentions.
- title_length (count): A factor that can impact audience interest, with shorter titles being easier to remember and share. This column is derived from the 'title' column in the dataset.
- release_season (binary): Many film studios release their most significant and most anticipated movies during Christmas and New Year to take advantage of the increased audience turnout and box office revenue potential. Here we considered two prominent holiday months (December & January) as one category and the rest as a different category.
- release_language (binary): Movies released in widely spoken languages such as English have a higher potential audience and, therefore may generate higher Revenue. The model can capture this effect by including release language as a covariate and make more accurate revenue predictions. Here we took English as a primary category and all other languages as a non-English category.  

Before running the regression model, we checked the multi-collinearity between all predictors by running a variation inflation factor to reduce unstable and unreliable estimates of the regression analysis. We observed there is no evidence of multi-collinearity between the predictor variables. 

We created three regression models on the 30% dataset to understand better to understand the factors contributing to the Revenue of a movie. The first model studied the correlation between budget and Revenue. In the second model, we gradually added covariates such as 'Vote Count' and 'Run time'. Finally, in the third model, we added more covariates such as Popularity, Movie Title Length, Release season, and Release Language.


$$
  \widehat{revenue}=\beta_0 + \beta_1\cdot budget +\mathbf{Z\gamma}
$$

where $\beta_0$ is the constant in the model, $\beta_1$ represents the budget coefficient, $\mathbf{Z}$ is a row vector of additional covariates, and $\mathbf{\gamma}$ is a column vector of coefficients.

Additionally, we evaluated homoscedasticity to check if the variance of the errors or residuals in the model is constant across all the predictor variables, but the results showed heteroscedastic behavior. Since our dataset is large, we will continue to build our model with robust standard errors to handle the heteroscedastic behavior.


# Results

Table 1 shows the results of three regression models with 70% dataset. We can also observe from Table 1 that Model 3 has the highest adjusted R-squared value of 0.67, indicating that it is the best-fitting model out of the three.

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide', include=FALSE}
model <- lm(log_revenue ~ log_budget, data = movie_sample_exploration)

model_2 <- lm(log_revenue ~ log_budget + vote_count + runtime , data = movie_sample_exploration)

model_5 <- lm(log_revenue ~ log_budget + vote_count + runtime + popularity + log_title_length + release_date_cat + lang_cat, data = movie_sample_exploration)
```



```{r, warning=FALSE, message=FALSE, include=FALSE, echo=FALSE}
movie_sample_statistical$log_budget <-log(movie_sample_statistical$budget/1000000)
movie_sample_statistical$log_title_length <- log(movie_sample_statistical$title_length)
movie_sample_statistical$log_revenue <-log(movie_sample_statistical$revenue/1000000)
movie_sample_statistical$lang_cat <- ifelse(movie_sample_statistical$original_language %in% c("en"), "1", "0")
movie_sample_statistical$release_date_cat <- ifelse(month(movie_sample_statistical$release_date) %in% c(1,12), "1", "0")

model <- lm(log_revenue ~ log_budget, data = movie_sample_statistical)

model_2 <- lm(log_revenue ~ log_budget + vote_count + runtime , data = movie_sample_statistical)

model_5 <- lm(log_revenue ~ log_budget + vote_count + runtime + popularity + log_title_length + release_date_cat + lang_cat, data = movie_sample_statistical)
```

```{r, warning=FALSE, message=FALSE, include=FALSE, echo=FALSE}
coeftest(model, vcov = vcovHC(model))
coeftest(model_2, vcov = vcovHC(model_2))
coeftest(model_5, vcov = vcovHC(model_5))
```


```{r, warning=FALSE, message=FALSE, include=FALSE, echo=FALSE}

model_11 <- lm(log_revenue ~ log_budget + vote_count + popularity + runtime + log_title_length + release_date_cat, data = movie_sample_statistical)

model_12 <- lm(log_revenue ~ log_budget + vote_count + popularity + runtime + log_title_length + lang_cat, data = movie_sample_statistical)

waldtest(model_11, model_5, vcov = vcovHC(model_5, type = "HC1"))
waldtest(model_12, model_5, vcov = vcovHC(model_5, type = "HC1"))

```




```{r display, message=FALSE, echo=FALSE, results='asis', warning=FALSE}
get_robust_se <- function(model) {
  se <- sqrt(diag(vcovHC(model, type = "HC1")))
  return(se)
}
rse_model <- get_robust_se(model)
rse_model_2 <- get_robust_se(model_2)
rse_model_5 <- get_robust_se(model_5)
#Stargazer table along with robust standard error
stargazer(model, model_2, model_5,
          type = "latex",
          table.placement = "H",
          omit.stat = "f",
          se=list(rse_model, rse_model_2, rse_model_5),
          title = "Estimated Regressions",
          header=FALSE,
          dep.var.caption  = "Output Variable: Revenue of the movie",
          covariate.labels = c("Budget", "Vote Count", "Run time", "Popularity", "Movie Title Length", "Release season", "Release Language"),
          dep.var.labels   = "",
          digits=3,
          column.sep.width = "2pt",
          #no.space = TRUE, 
          star.cutoffs = c(0.05, 0.01, 0.001),
          notes.append = FALSE,
          notes = "\\parbox[t]{10cm}{*p<0.1; **p<0.05; ***p<0.01. $HC_1$ robust standard errors specified in parentheses. Release season is Dec/Jan and rest of the months are considered as non-holiday season. Release Language Category is either English or Non-English movies.}"
          )
```

The coefficient of the X-concept variable "Budget" is having higher statistical significance in all three models. Point estimates range from 0.91 to 0.77, showing that the variable budget has a positive relationship between the other covariates and the Revenue. It is also evident from the table that all the covariates are statistically significant, having a p-value less than 0.05 (alpha level). The co-variates vote count, runtime, and release season show more statistical significance than other covariates. We also conducted a "Wald" test to study the statistical significance of the two categorical covariates (Release Season and Release Language), and the results reassured us that they are also statistically significant variables in the model.

To better understand the practical significance of the results, let’s consider a hypothetical use case with 180 minutes movie being produced with a million-dollar budget with a shorter title length of 10, the Model 3 shows the Revenue of the movie could increase to \$772,000. However, if the movie is produced in the English language and gets released during December/January, the combined Revenue for these categories could increase by 33.7%.

These results emphasize that budget is a crucial factor in determining the Revenue of a movie. We also observed, along with the budget, the categorical predictors of release season and release language play a significant role contributing to the Revenue of the movie. Apart from these, the covariates vote count, runtime, popularity, and title length also contributed towards the Revenue. We believe that Model 3 can assist movie production companies in making informed decisions about the various factors involved in the overall planning process, which is essential for the success of the movie.



# Limitations

The Dataset has a chance of introducing Sampling Bias as the data about the movies is self-reported on TMDB, which is a user-generated content platform. Thus, the dataset may represent some movies but the dataset cannot be representative of all movies that have been produced globally. The data may also be biased toward movies that are more popular than others.

The I.I.D assumption becomes questionable after closely examining the movie dataset because two movies may share the same cast & crew, and production company and have identical release dates.

The dataset does not mention any information about Motion Picture Association of America(MPAA) Ratings, which have the possibility of influencing the Revenue. Likewise, actors may influence both budget & Revenue of the movie. The dataset may not represent a true picture of the current movie industry/trends since it contains information on movies which has a release date before 2013. As the movie industry is rapidly changing, trends become outdated quickly. Moreover, there is no consideration of inflation when concluding the statistical analysis between covariates such as budget & Revenue. These variables may introduce omitted variable bias in our model.

Also, in the model, we have an outcome variable, "Vote count" on the RHS. This variable can be an outcome of the predictor "Popularity". The reason could be because of promotions, more people can engage with the movie, which could lead to an increase in the number of votes.


# Conclusion

This study estimated the economic value of movie production, specifically examining the relationship between movie budget and Revenue. We also found that several covariates, such as vote_count, runtime, popularity, title length, release season, and release language, have a significant impact on movie revenue. Additionally, we identified the holiday season and language as other important categorical factors that can impact the success of a movie. We hope that this line of work will provide filmmakers with accurate tools to plan their investments and optimize their production strategies, reducing uncertainty in the film industry. Future work may explore the correlation of Revenue with additional data like MPAA ratings, cast/crew information, and sequel information on previous releases for identifying the latest trends in the movie industry.


```{r, message=FALSE, warning=FALSE, fig.width=10, fig.height=5, include=FALSE, echo=FALSE}
#table(movie_sample_statistical$release_date_cat)
#library("writexl")
#write_xlsx(movie_sample_statistical,"C:\\Users\\sivak\\Downloads\\movies\\movies_release_cat.xlsx")
plot_release_cat <- ggplot(movie_sample_exploration, 
       aes(x=budget/1000000, y=revenue/1000000)) +
  geom_point(aes(color=release_date_cat)) +
  #geom_point() +
  geom_smooth(se=FALSE) +
  xlab("Budget") +
  ylab("Revenue") +
  ggtitle("Budget vs Revenue") +
  scale_x_continuous(labels = scales::comma) +
  scale_y_continuous(labels = scales::comma)

plot_lang_cat <- ggplot(movie_sample_exploration, 
       aes(x=budget/1000000, y=revenue/1000000)) +
  geom_point(aes(color=lang_cat)) +
  #geom_point() +
  geom_smooth(se=FALSE) +
  xlab("Budget") +
  ylab("Revenue") +
  xlim(0,200) + 
  ggtitle("Budget vs Revenue") +
  scale_x_continuous(labels = scales::comma) +
  scale_y_continuous(labels = scales::comma)
(plot_release_cat | plot_lang_cat)
```


